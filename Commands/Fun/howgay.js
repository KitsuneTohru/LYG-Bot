//-----Check How Gay, B·∫£n C·∫£i Ti·∫øn (v3.0)-----\\
//Gi·∫£i Th√≠ch Code
//======================================================
/*1. T·ªâ L·ªá: 0% - 101% (ƒê·ªìng Nghƒ©a Random 101.1)
**2. Easter Egg (Hi·∫øm) K√≠ch Ho·∫°t Khi ƒê·∫°t T·ª´ 100.1 - 101%
**3. C√≥ M·ªôt S·ªë Entry ƒê·∫∑c Bi·ªát Nh∆∞ 403, 404, 727, ...
/*3. C√≥ M·ªôt S·ªë User S·∫Ω ƒê∆∞·ª£c Bypass N√≥ (T√πy Thu·ªôc)
========================================================*/

const { SlashCommandBuilder, EmbedBuilder } = require('discord.js');
const wait = require('node:timers/promises').setTimeout;
const cdSchema = require('../../Database/cooldown')
const HGList = require('../../Assets/Howgay/hglist')
const HGAssets = require('../../Assets/Howgay/hgassets')
const HGColors = require('../../Assets/Howgay/hgcolors')
const FooterEmbeds = require('../../Utils/embed')

module.exports = {
    data: new SlashCommandBuilder()
        .setName('howgay')
        .setDescription('Check ƒê·ªô Gay C·ªßa M·ªôt User N√†o ƒê√≥ (J4F, RAGE B·ªä TR√äU R√ÅNG CH·ªäU!)')
        .addUserOption(option =>
            option.setName('target')
                .setDescription('M·ª•c Ti√™u M√† B·∫°n Mu√≥n Nh·∫Øm T·ªõi')
                .setRequired(true))
        .addBooleanOption(option =>
            option.setName('avgset')
                .setDescription('T√≠nh Trung B√¨nh Gay C·ªßa User N√†o ƒê√≥ (C·ªê ƒê·ªäNH: 3 L·∫¶N)')
                .setRequired(false)),

    async execute(interaction) {
        const FooterEmbeds_ = FooterEmbeds
        //CDTime
        const cdtime = 300000
        //L·∫•y User V√† AvgSet
        const user = interaction.options.getUser('target')
        var avgbool = interaction.options.getBoolean('avgset')
        if (avgbool === null) {
            avgbool = false
        }
        //Set M·∫£ng
        const HGAsset = HGAssets
        const HGColor = HGColors
        const EntryList = HGList
        const NumEntry = [10, 25, 50, 75, 90, 100, 101]
        const SpecialEntry = [40.3, 40.4, 72.7]
        //Easter
        const rngv2 = Math.floor(Math.random() * 100)
        const easter_url = HGAsset[0][2]
        const easter_result = '<:LYG_XD:1087375888276000788> **|** Kh√¥ng Sao Kh√¥ng Sao, C√≥ Ch·ªß Nh√¢n ·ªû ƒê√¢y Bi·∫øn ƒê·ªïi C·∫≠u R·ªìi, C·∫≠u S·∫Ω L√† Thu·ªôc H·∫° C·ªßa T√¥i Th√¥i\nSrc: Manga From: **Shio Ayatsuki** ||Th·ª±c Ch·∫•t L√† B·ªô "210" ƒê·∫•y √Å =))||'
        const spcl_chr = ('`/howgay`')
        const H100PlusEmbed = new EmbedBuilder()
            .setAuthor({ name: `${interaction.user.username}`, iconURL: `${interaction.user.displayAvatarURL({ dynamic: true, size: 512 })}` })
            .setTitle('üè≥Ô∏è‚Äçüåà **- B√≠ M·∫≠t C·ªßa Command XD...**')
            .setColor(HGColor[1][1])
            .setDescription(`${easter_result}`)
            .setTimestamp()
            .setImage(easter_url)
            .setFooter({ text: `${FooterEmbeds_[0][0]}`, iconURL: `${FooterEmbeds_[1][Math.floor(Math.random()*FooterEmbeds_[1].length)]}` })
        //Ch·ªù Embed...
        const CalcEmbed = new EmbedBuilder()
            .setAuthor({ name: `${interaction.user.username}`, iconURL: `${interaction.user.displayAvatarURL({ dynamic: true, size: 512 })}` })
            .setTitle('üè≥Ô∏è‚Äçüåà **- Check Ch·ªâ S·ªë Gay C·ªßa Ai ƒê√≥...**')
            .setColor('#FFFFFF')
            .setDescription(`<a:LYG_LoadSlot:1087377575107645569> **|** H·ªá Th·ªëng ƒêang Ki·ªÉm Tra ƒê·ªô Gay C·ªßa ${user}... Xin Ch·ªù M·ªôt L√°t...\n**L∆ØU √ù:** ƒê·ª´ng L·∫•y Chuy·ªán N√†y L√†m Chuy·ªán Nghi√™m T√∫c Nh√°! Qu·∫°o R·ªìi Kh√¥ng Ai Ch·ªãu Tr√°ch Nhi·ªám ƒê√¢u!`)
            .setTimestamp()
            .setFooter({ text: `${FooterEmbeds_[0][0]}`, iconURL: `${FooterEmbeds_[1][Math.floor(Math.random()*FooterEmbeds_[1].length)]}` })
        //Lock User + H√†m L·∫•y So S√°nh
        const lock_user = ['751225225047179324', '786816081032773662', '927221951439700058', '809259609700302935', '888738277044133899', '764825231335620619', '790882475173609472', '594540792090198016']
        var lock_output = false
        function Compare(user, lock_user) {
            for (var count in lock_user) {
                if (user.id === lock_user[count]) {
                    lock_output = true
                }
            }
        }
        Compare(user, lock_user)
        //Lock Embed
        var lock_desc, lock_img
        lock_desc = `<:LYG_KeqingDoi:1086190826536849499> **|** Oi! B·∫°n **KH√îNG TH·ªÇ** Check C√¢u L·ªánh ${spcl_chr} L√™n ${user} ƒê∆∞·ª£c! H√£y Th·ª≠ V·ªõi Ng∆∞·ªùi Kh√°c ƒêi!`
        lock_img = HGAsset[0][0]
        if (user.id === '764825231335620619') {
            lock_desc = `<:go_MokouFire:1092052285732954132> **|** ƒê·ªÉ T∆∞·ªüng Nh·ªõ Ng∆∞·ªùi B·∫°n ƒê√£ Khu·∫•t C·ªßa Ch·ªß Bot, B·∫°n **KH√îNG TH·ªÇ** Check C√¢u L·ªánh ${spcl_chr} L√™n ${user} ƒê∆∞·ª£c! H√£y Th·ª≠ V·ªõi Ng∆∞·ªùi Kh√°c ƒêi Nh√°!\n> **Kitsunezi's Note:** *"Vƒ©nh Bi·ªát, Ng∆∞·ªùi B·∫°n T·ªët C·ªßa T√¥i, √îng L√† Ng∆∞·ªùi ƒê√£ M·ªü ƒê∆∞·ªùng Cho T√¥i ƒê·∫øn V·ªõi S·ª± Nghi·ªáp N√†y. An Ngh·ªâ Nh√©, Shen, B·∫°n T√¥i..."*`
            lock_img = HGAsset[0][1]
        }


        const SpecialEmbed = new EmbedBuilder()
            .setAuthor({ name: `${interaction.user.username}`, iconURL: `${interaction.user.displayAvatarURL({ dynamic: true, size: 512 })}` })
            .setTitle('üè≥Ô∏è‚Äçüåà **- Check Ch·ªâ S·ªë Gay C·ªßa Ai ƒê√≥...**')
            .setColor('#6E0000')
            .setDescription(lock_desc)
            .setTimestamp()
            .setImage(lock_img)
            .setFooter({ text: `${FooterEmbeds_[0][0]}`, iconURL: `${FooterEmbeds_[1][Math.floor(Math.random()*FooterEmbeds_[1].length)]}` })
        //avgbool == False
        if (avgbool == false) {
            var rng = Math.random() * 101.1
            rng = (Math.floor(rng * 10) / 10).toFixed(1)
            //rng = 100.1 //CH·ªà G·ª† KHI TEST (C·∫§M L·∫†M D·ª§NG NH√Å XD)

            var img_url, color, result
            for (var i = 0; i < NumEntry.length; i++) {
                if (rng <= NumEntry[i]) {
                    img_url = HGAsset[0][2]
                    color = HGColor[0][i]
                    result = `Ch·ªâ S·ªë Gay C·ªßa ${user} L√†: **${rng}%**\n` + EntryList[i][Math.floor(Math.random() * EntryList[i].length)]
                    if (rng < 1) {
                        img_url = HGAsset[1][Math.floor(Math.random() * HGAsset[1].length)]
                        if (interaction.guild.id === '900742301373042809') {
                            result += '\n> B·∫°n ƒê√£ ƒê∆∞·ª£c Nh·∫≠n Role T·∫∑ng K√®m: <@&1171750121109733438>\n> Ghi Ch√∫: N·∫øu B·∫°n C√≥ Role <@&1162944612508377088> Th√¨ B·∫°n Ch·ªâ ƒê∆∞·ª£c G·ª° Role N√†y Th√¥i, Kh√¥ng Nh·∫≠n Role Kia'
                        }
                        break
                    }
                    if (rng > 100) {
                        img_url = HGAsset[2][Math.floor(Math.random() * HGAsset[2].length)]
                        if (interaction.guild.id === '900742301373042809') {
                            result += '\n> B·∫°n ƒê√£ ƒê∆∞·ª£c Nh·∫≠n Role T·∫∑ng K√®m: <@&1162944612508377088>\n> Ghi Ch√∫: N·∫øu B·∫°n C√≥ Role <@&1171750121109733438> Th√¨ B·∫°n Ch·ªâ ƒê∆∞·ª£c G·ª° Role N√†y Th√¥i, Kh√¥ng Nh·∫≠n Role Kia'
                        }
                        break
                    }
                    for (var j = 0; j < SpecialEntry.length; j++) {
                        if (rng === SpecialEntry[j]) {
                            color = HGColor[1][0]
                            img_url = HGAsset[3][j]
                            result = `Ch·ªâ S·ªë Gay C·ªßa ${user} L√†: **${rng}%**\n` + EntryList[7][j]
                            break
                        }
                    }
                    break
                }
            }



            console.log('========================================\nRng Encounter:', rng, '\nRngv2 Encounter:', rngv2, '\n========================================')
        }
        //avgbool == True
        else {
            var a = []
            var avgpt = 0, colorv2, resultv2, resultv3, img_urlv2, rngv3
            for (var i = 0; i < 3; i++) {
                rngv3 = Math.random() * 101.1
                rngv3 = (Math.floor(rngv3 * 10) / 10).toFixed(1)
                avgpt = avgpt + Number(rngv3)
                resultv2 = (`<a:LYG_Ping:900775951317737473> **|** Ch·ªâ S·ªë Gay C·ªßa ${user} **__(L·∫ßn: ${i + 1})__** L√†: **${rngv3}%**`)
                a[i] = resultv2
                console.log('========================================\nT√≠nh To√°n Theo Rngv3 (L·∫ßn', i + 1, ') =', rngv3, '\n========================================')
            }

            avgpt = avgpt / 3
            avgpt = (Math.floor(avgpt * 10) / 10).toFixed(1)
            //avgpt = 100.1 //CH·ªà G·ª† KHI TEST (C·∫§M L·∫†M D·ª§NG NH√Å XD)

            for (var i = 0; i < NumEntry.length; i++) {
                if (avgpt <= NumEntry[i]) {
                    img_urlv2 = HGAsset[0][2]
                    colorv2 = HGColor[0][i]
                    resultv3 = `Ch·ªâ S·ªë Gay C·ªßa ${user} L√†: **${avgpt}%**\n` + EntryList[i][Math.floor(Math.random() * EntryList[i].length)]
                    for (var j = 0; j < SpecialEntry.length; j++) {
                        if (avgpt === SpecialEntry[j]) {
                            colorv2 = HGColor[1][0]
                            img_urlv2 = HGAsset[3][j]
                            resultv3 = `Ch·ªâ S·ªë Gay C·ªßa ${user} L√†: **${avgpt}%**\n` + EntryList[7][j]
                            break
                        }
                    }
                    if (avgpt < 1) {
                        img_urlv2 = HGAsset[1][Math.floor(Math.random() * HGAsset[1].length)]
                        if (interaction.guild.id === '900742301373042809') {
                            resultv3 += '\n> B·∫°n ƒê√£ ƒê∆∞·ª£c Nh·∫≠n Role T·∫∑ng K√®m: <@&1171750121109733438>\n> Ghi Ch√∫: N·∫øu B·∫°n C√≥ Role <@&1162944612508377088> Th√¨ B·∫°n Ch·ªâ ƒê∆∞·ª£c G·ª° Role N√†y Th√¥i, Kh√¥ng Nh·∫≠n Role Kia'
                        }
                        break
                    }
                    if (avgpt > 100) {
                        img_urlv2 = HGAsset[2][Math.floor(Math.random() * HGAsset[2].length)]
                        if (interaction.guild.id === '900742301373042809') {
                            resultv3 += '\n> B·∫°n ƒê√£ ƒê∆∞·ª£c Nh·∫≠n Role T·∫∑ng K√®m: <@&1162944612508377088>\n> Ghi Ch√∫: N·∫øu B·∫°n C√≥ Role <@&1171750121109733438> Th√¨ B·∫°n Ch·ªâ ƒê∆∞·ª£c G·ª° Role N√†y Th√¥i, Kh√¥ng Nh·∫≠n Role Kia'
                        }
                        break
                    }
                    break
                }
            }
        }
        //Embed(False)
        if (avgbool === false) {
            GayEmbed_1 = new EmbedBuilder()
                .setAuthor({ name: `${interaction.user.username}`, iconURL: `${interaction.user.displayAvatarURL({ dynamic: true, size: 512 })}` })
                .setTitle('üè≥Ô∏è‚Äçüåà **- Check Ch·ªâ S·ªë Gay C·ªßa Ai ƒê√≥...**')
                .setColor(color)
                .setDescription(`${result}`)
                .setTimestamp()
                .setImage(img_url)
                .setFooter({ text: `${FooterEmbeds_[0][0]}`, iconURL: `${FooterEmbeds_[1][Math.floor(Math.random()*FooterEmbeds_[1].length)]}` })
        }
        //Embed(True)
        if (avgbool === true) {
            var AvgGayEmbed = []
            const color1 = 'DarkButNotBlack'
            const color2 = colorv2
            const imgv2 = img_urlv2
            const avgdesc = [
                `<a:LYG_Clock:1084322030331105370> ƒêang Trong T√≠nh To√°n... Xin H√£y Ki√™n Nh·∫´n...\n> ${a[0]}`,
                `<a:LYG_Clock:1084322030331105370> ƒêang Trong T√≠nh To√°n... Xin H√£y Ki√™n Nh·∫´n...\n> ${a[0]}\n> ${a[1]}`,
                `<a:LYG_Clock:1084322030331105370> ƒêang Trong T√≠nh To√°n... Xin H√£y Ki√™n Nh·∫´n...\n> ${a[0]}\n> ${a[1]}\n> ${a[2]}`,
                `<a:LYG_Star:1084085189174632538> K·∫øt Qu·∫£ Kh·∫£o S√°t:\n> ${a[0]}\n> ${a[1]}\n> ${a[2]}\n${resultv3}`,
            ]
            for (var count = 0; count <= 3; count++) {
                var finalcolor
                if (count < 3) {
                    finalcolor = color1
                }
                else {
                    finalcolor = color2
                }
                AvgGayEmbed[count] = new EmbedBuilder()
                    .setAuthor({ name: `${interaction.user.username}`, iconURL: `${interaction.user.displayAvatarURL({ dynamic: true, size: 512 })}` })
                    .setTitle('üè≥Ô∏è‚Äçüåà **- Check Ch·ªâ S·ªë Gay C·ªßa Ai ƒê√≥...**')
                    .setColor(finalcolor)
                    .setDescription(avgdesc[count])
                    .setTimestamp()
                    .setImage(imgv2)
                    .setFooter({ text: `${FooterEmbeds_[0][0]}`, iconURL: `${FooterEmbeds_[1][Math.floor(Math.random()*FooterEmbeds_[1].length)]}` })
            }
        }
        const auser = interaction.user.id
        function BypassCD(auser) {
            const CDPassList = ['751225225047179324', '786816081032773662', '927221951439700058', '892054339072438303', '961838901792735243']
            for (var i in CDPassList) {
                if (auser === CDPassList[i]) {
                    return true
                }
            }
            return false
        }
        const Bypass_ = BypassCD(auser)
        cdSchema.findOne({ UserID: interaction.user.id }, async (err, data) => {
            if (err) throw err
            if (!data) {
                cdSchema.create({
                    UserID: interaction.user.id,
                    CDHowgay: Date.now(),
                })
            } if (data) {
                const cduser = data.UserID
                const CDTime = data.CDHowgay
                console.log('[Command: Howgay]', cduser, CDTime, Date.now())
                if (CDTime > Date.now() && !Bypass_) {
                    const cdembed = new EmbedBuilder()
                        .setColor('Red')
                        .setTitle(`<a:LYG_Clock:1084322030331105370> **Command - Cooldown**`)
                        .setAuthor({ name: `${interaction.user.username}`, iconURL: `${interaction.user.displayAvatarURL({ dynamic: true, size: 512 })}` })
                        .setDescription(`<:LYG_FubukiPing1:1084085915368050788> | <@${cduser}> Oi! B·∫°n Ph·∫£i Ch·ªù ƒê·∫øn <t:${Math.round(CDTime / 1000)}> (<t:${Math.round(CDTime / 1000)}:R>) M·ªõi C√≥ Th·ªÉ Th·ª±c Hi·ªán L·ªánh Nh√©!`)
                        .setTimestamp()
                        .setFooter({ text: `${FooterEmbeds_[0][0]}`, iconURL: `${FooterEmbeds_[1][Math.floor(Math.random()*FooterEmbeds_[1].length)]}` })
                    await interaction.reply({
                        embeds: [cdembed]
                    })
                }
                else {
                    data.CDHowgay = Date.now() + cdtime
                    data.save()
                    //Reply(Ph·ª• Thu·ªôc V√†o ƒêi·ªÅu Ki·ªán)
                    await interaction.reply({
                        embeds: [CalcEmbed]
                    })
                    await wait(3000)
                    if (avgbool === false) {
                        if (lock_output) {
                            await interaction.editReply({
                                embeds: [SpecialEmbed]
                            })
                        }
                        else {
                            await interaction.editReply({
                                embeds: [GayEmbed_1]
                            })
                        }
                        await wait(500)
                        if (rng > 100 && rngv2 >= 95 && !lock_output) {
                            await interaction.followUp({
                                embeds: [H100PlusEmbed]
                            })
                        }
                    }
                    else {
                        if (lock_output) {
                            await interaction.editReply({
                                embeds: [SpecialEmbed]
                            })
                        }
                        else {
                            for (var embed = 0; embed <= 3; embed++) {
                                if (!lock_output) {
                                    await wait(500)
                                    await interaction.editReply({
                                        embeds: [AvgGayEmbed[embed]]
                                    })
                                }
                                else break
                            }
                        }
                        await wait(500)
                        if (rng > 100 && rngv2 >= 95 && !lock_output) {
                            await interaction.editReply({
                                embeds: [H100PlusEmbed]
                            })
                        }
                    }
                }
            }
        })
    }
}